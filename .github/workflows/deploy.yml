name: Deploy

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18.x'

jobs:
  # Determine deployment environment
  setup:
    name: Setup Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/tags/v"* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # Run full CI pipeline before deploying
  ci-checks:
    name: Pre-deployment Checks
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    uses: ./.github/workflows/ci.yml

  # Build for deployment
  build:
    name: Build for Deployment
    runs-on: ubuntu-latest
    needs: [setup, ci-checks]
    if: needs.setup.outputs.should_deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build API
        run: npx nx build api --configuration=production

      - name: Build UI
        run: npx nx build ui --configuration=production
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r dist/apps/api deployment/api
          cp -r dist/apps/ui deployment/ui
          cp package*.json deployment/
          tar -czf deployment-${{ needs.setup.outputs.environment }}.tar.gz deployment/

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ needs.setup.outputs.environment }}
          path: deployment-${{ needs.setup.outputs.environment }}.tar.gz
          retention-days: 30

  # Deploy API
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [setup, build]
    environment: ${{ needs.setup.outputs.environment }}
    if: needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-${{ needs.setup.outputs.environment }}

      - name: Extract deployment package
        run: tar -xzf deployment-${{ needs.setup.outputs.environment }}.tar.gz

      - name: Deploy to server (placeholder)
        run: |
          echo "üöÄ Deploying API to ${{ needs.setup.outputs.environment }}"
          echo "This is where you would deploy using:"
          echo "- SSH/SCP to your server"
          echo "- Docker registry push"
          echo "- AWS/Azure/GCP deployment"
          echo "- Kubernetes apply"
          # Example: 
          # - scp deployment/api/* user@server:/path/to/api
          # - ssh user@server 'cd /path/to/api && pm2 restart api'

      - name: Health check
        run: |
          echo "üè• Running health check..."
          # Example: curl ${{ secrets.API_URL }}/health

  # Deploy UI
  deploy-ui:
    name: Deploy UI
    runs-on: ubuntu-latest
    needs: [setup, build]
    environment: ${{ needs.setup.outputs.environment }}
    if: needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-${{ needs.setup.outputs.environment }}

      - name: Extract deployment package
        run: tar -xzf deployment-${{ needs.setup.outputs.environment }}.tar.gz

      - name: Deploy to hosting (placeholder)
        run: |
          echo "üöÄ Deploying UI to ${{ needs.setup.outputs.environment }}"
          echo "This is where you would deploy using:"
          echo "- Static hosting (Netlify, Vercel, Cloudflare Pages)"
          echo "- S3 + CloudFront"
          echo "- Azure Static Web Apps"
          # Example for S3:
          # - aws s3 sync deployment/ui/ s3://your-bucket/ --delete
          # - aws cloudfront create-invalidation --distribution-id YOUR_ID --paths "/*"

  # Database migrations (if needed)
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [setup, build]
    environment: ${{ needs.setup.outputs.environment }}
    if: needs.setup.outputs.should_deploy == 'true' && needs.setup.outputs.environment == 'production'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run migrations
        run: |
          echo "üìä Running database migrations..."
          # Add your migration commands here
          # npm run migrate

  # Post-deployment tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [setup, deploy-api, deploy-ui]
    environment: ${{ needs.setup.outputs.environment }}
    if: needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: API health check
        run: |
          echo "üè• Checking API health..."
          # curl -f ${{ secrets.API_URL }}/health || exit 1

      - name: UI availability check
        run: |
          echo "üåê Checking UI availability..."
          # curl -f ${{ secrets.UI_URL }} || exit 1

      - name: Critical path tests
        run: |
          echo "üß™ Running critical path tests..."
          # Add smoke tests for critical functionality

  # Rollback capability
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [setup, smoke-tests]
    if: failure() && needs.setup.outputs.should_deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Rollback deployment
        run: |
          echo "‚è™ Rolling back deployment..."
          echo "Implement rollback strategy here"
          # Restore previous version from backup
          # Or deploy previous successful build

  # Success notification
  notify-success:
    name: Deployment Success
    runs-on: ubuntu-latest
    needs: [setup, smoke-tests]
    if: success() && needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: Send success notification
        run: |
          echo "‚úÖ Deployment to ${{ needs.setup.outputs.environment }} successful!"
          echo "View at: ${{ secrets.UI_URL }}"
